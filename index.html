import cv2
import pytesseract
import re
from collections import Counter

# Náº¿u báº¡n dÃ¹ng Windows, bá» comment dÃ²ng sau vÃ  chá»‰nh Ä‘Ãºng Ä‘Æ°á»ng dáº«n tá»›i tesseract.exe
# pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'

def extract_results_from_image(image_path):
    """
    Äá»c áº£nh vÃ  trÃ­ch xuáº¥t chuá»—i káº¿t quáº£ TÃ i/Xá»‰u tá»« áº£nh báº±ng OCR
    """
    image = cv2.imread(image_path)
    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)
    text = pytesseract.image_to_string(gray, lang='eng')
    
    # Lá»c ra kÃ½ tá»± T (TÃ i) hoáº·c X (Xá»‰u) viáº¿t hoa
    results = re.findall(r'[TX]', text.upper())
    return results

def detect_pattern(results):
    """
    PhÃ¢n tÃ­ch cÃ¡c máº«u cáº§u 3 káº¿t quáº£ liÃªn tiáº¿p vÃ  káº¿t quáº£ tiáº¿p theo
    """
    pattern_counts = {}
    for i in range(len(results)-3):
        pattern = tuple(results[i:i+3])
        next_result = results[i+3]
        if pattern not in pattern_counts:
            pattern_counts[pattern] = {'T': 0, 'X': 0}
        pattern_counts[pattern][next_result] += 1
    return pattern_counts

def predict_next(results, pattern_counts):
    """
    Dá»± Ä‘oÃ¡n xÃ¡c suáº¥t ra TÃ i/Xá»‰u dá»±a trÃªn cáº§u gáº§n nháº¥t
    """
    if len(results) < 3:
        return "âŒ KhÃ´ng Ä‘á»§ dá»¯ liá»‡u Ä‘á»ƒ dá»± Ä‘oÃ¡n."

    last_pattern = tuple(results[-3:])
    if last_pattern in pattern_counts:
        total = sum(pattern_counts[last_pattern].values())
        t_prob = pattern_counts[last_pattern]['T'] / total * 100
        x_prob = pattern_counts[last_pattern]['X'] / total * 100
        return (
            f"ğŸ§  PhÃ¢n tÃ­ch cáº§u: {last_pattern}\n"
            f"ğŸ”® Dá»± Ä‘oÃ¡n káº¿t quáº£ tiáº¿p theo:\n"
            f"ğŸ‘‰ TÃ i (T): {t_prob:.2f}%\n"
            f"ğŸ‘‰ Xá»‰u (X): {x_prob:.2f}%"
        )
    else:
        return "âš ï¸ KhÃ´ng cÃ³ cáº§u trÃ¹ng khá»›p trong lá»‹ch sá»­. KhÃ´ng thá»ƒ dá»± Ä‘oÃ¡n cháº¯c cháº¯n."

def main():
    image_path = 'lich_su_taixiu.png'  # Thay báº±ng Ä‘Æ°á»ng dáº«n áº£nh báº¡n cÃ³
    print(f"ğŸ“· Äang xá»­ lÃ½ áº£nh: {image_path}...")

    results = extract_results_from_image(image_path)
    print(f"âœ… Káº¿t quáº£ nháº­n dáº¡ng tá»« áº£nh: {results}")

    pattern_counts = detect_pattern(results)
    prediction = predict_next(results, pattern_counts)
    print("\nğŸ“Š Káº¿t quáº£ phÃ¢n tÃ­ch vÃ  dá»± Ä‘oÃ¡n:")
    print(prediction)

if __name__ == "__main__":
    main()
